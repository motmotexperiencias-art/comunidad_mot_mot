<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil P√∫blico - Mot Mot</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>

    <style>
        :root { --naranja: #E65127; --turquesa: #80C4C8; --negro: #1a1a1a; --gris-fondo: #f4f6f8; --dorado: #D4AF37; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--gris-fondo); margin: 0; padding: 0; color: var(--negro); }
        .nav-perfil { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .container { max-width: 800px; margin: 40px auto; padding: 20px; }
        .card-perfil { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); text-align: center; position: relative; }
        .foto-perfil { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid var(--turquesa); margin-bottom: 20px; }
        .rol-usuario { background: var(--turquesa); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8em; text-transform: uppercase; display: inline-block; }
        .nombre-usuario { font-size: 2.2em; font-weight: 900; margin: 15px 0 5px; text-transform: uppercase; }
        .ubicacion { color: #666; font-weight: 500; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .lema { font-style: italic; color: var(--naranja); font-weight: 600; margin: 15px 0; font-size: 1.1em; }
        .bio { color: #555; line-height: 1.6; max-width: 600px; margin: 20px auto; font-size: 0.95em; }
        .tags-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 20px; }
        .tag { background: #eee; padding: 6px 14px; border-radius: 20px; font-size: 0.8em; font-weight: 600; color: #444; }
        
        /* EXPERIENCIAS (Cards) */
        h3 { margin-top: 40px; border-bottom: 2px solid #eee; padding-bottom: 10px; color: var(--naranja); font-weight: 800; text-transform: uppercase; font-size: 0.95em; text-align: left; }
        .exp-card { background: #fdfdfd; border: 1px solid #eee; border-radius: 15px; overflow: hidden; margin-top: 20px; text-align: left; transition: 0.3s; }
        .exp-header { padding: 15px; background: #fffbf0; border-bottom: 1px dashed #ddd; }
        .exp-titulo { font-weight: 900; font-size: 1.1em; color: var(--negro); margin: 0; }
        .exp-lugar { font-size: 0.8em; color: #666; font-weight: bold; }
        .exp-desc { padding: 15px; font-size: 0.9em; color: #444; line-height: 1.4; }
        .exp-galeria { display: flex; gap: 8px; padding: 0 15px 15px; overflow-x: auto; scrollbar-width: thin; }
        .exp-foto { height: 120px; min-width: 120px; border-radius: 10px; object-fit: cover; cursor: pointer; transition: 0.3s; border: 1px solid #eee; }
        .exp-foto:hover { transform: scale(1.05); }

        /* Botones de Acci√≥n */
        .btn-action { position: absolute; top: 20px; right: 20px; padding: 10px 22px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 0.85em; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; z-index: 10; cursor: pointer; border: none; }
        #btn-edit { background: var(--naranja); color: white; }
        
        /* INYECCI√ìN: ESTILOS BOT√ìN SEGUIR */
        #btn-seguir { background: var(--negro); color: white; }
        #btn-seguir.pendiente { background: #eee; color: #555; }
        #btn-seguir.siguiendo { background: var(--turquesa); color: white; }
        .btn-action:hover { transform: translateY(-2px); filter: brightness(1.1); }

        /* INYECCI√ìN: ESTILOS CONTADORES RED SOCIAL */
        .stats-red-social { display: flex; justify-content: center; gap: 30px; margin-top: 15px; }
        .stat-item { text-align: center; }
        .stat-num { display: block; font-size: 1.5em; font-weight: 900; color: var(--negro); }
        .stat-label { font-size: 0.7em; text-transform: uppercase; color: #888; font-weight: bold; }

        /* INYECCI√ìN: CANDADO PRIVACIDAD */
        .bloqueo-privacidad { background: #fafafa; border: 2px dashed #ccc; border-radius: 15px; padding: 40px 20px; text-align: center; margin-top: 30px; }
        .candado-icon { font-size: 3em; margin-bottom: 10px; }

        /* Comentarios */
        .comments-section { text-align: left; margin-top: 50px; background: #fff; padding-top: 20px; border-top: 1px solid #eee; }
        .comment-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-family: 'Montserrat'; margin-bottom: 12px; box-sizing: border-box; font-size: 0.9em; }
        .btn-comentar { background: var(--negro); color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: 800; font-size: 0.8em; text-transform: uppercase; }
        .lista-comentarios { margin-top: 25px; display: flex; flex-direction: column; gap: 15px; }
        .comentario-item { background: #f8f9fa; padding: 15px; border-radius: 15px; border-left: 4px solid var(--turquesa); }
        .comentario-autor { font-weight: 800; color: var(--naranja); font-size: 0.9em; display: flex; justify-content: space-between; }
        .comentario-fecha { font-weight: 400; color: #999; font-size: 0.8em; }
        .comentario-texto { font-size: 0.9em; color: #333; margin-top: 8px; line-height: 1.4; }

        /* INYECCI√ìN: CAMPANITA */
        .icono-campana { font-size: 1.5em; cursor: pointer; position: relative; text-decoration: none; margin-right: 15px;}
        .punto-rojo { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.5em; font-weight: bold; display: none; border: 2px solid white;}

        /* PARCHE M√ìVIL RESPONSIVE */
        @media (max-width: 768px) {
            .container { margin: 10px auto; padding: 10px; }
            .card-perfil { padding: 20px 15px; border-radius: 15px; }
            .nav-perfil { padding: 10px 15px; flex-direction: column; gap: 10px; text-align: center; }
            .nombre-usuario { font-size: 1.6em !important; }
            .stats-red-social { gap: 15px; }
            .stat-num { font-size: 1.2em; }
            .btn-action { position: relative; top: 0; right: 0; width: 100%; display: block; margin-bottom: 15px; box-sizing: border-box; }
        }
    </style>
</head>
<body>
    <nav class="nav-perfil">
        <img src="https://www.motmotexperiencias.com/wp-content/uploads/2023/08/cropped-Logo-foto-de-perfil-instagram.png" height="35" style="cursor:pointer" onclick="window.location.href='dashboard.html'">
        <div style="display:flex; align-items:center;">
            <a href="perfil.html" class="icono-campana">
                üîî<span id="notificacion-roja" class="punto-rojo">0</span>
            </a>
            <a href="dashboard.html" style="text-decoration:none; color:var(--naranja); font-weight:800;">‚Üê IR AL DASHBOARD</a>
        </div>
    </nav>
    <div class="container">
        <div class="card-perfil">
            <div id="loading">‚ú® Preparando bit√°cora...</div>
            
            <a href="perfil.html" id="btn-edit" class="btn-action" style="display:none;">‚úèÔ∏è Editar Perfil</a>
            
            <button id="btn-seguir" class="btn-action" style="display:none;">‚ûï Seguir</button>

            <div id="perfil-content" style="display: none;">
                <img id="p-foto" class="foto-perfil" src="">
                <br>
                <span id="p-rol" class="rol-usuario">Caminante</span>
                <h1 id="p-nombre" class="nombre-usuario">...</h1>
                <div class="ubicacion">üìç <span id="p-ubicacion">...</span></div>
                
                <div class="stats-red-social">
                    <div class="stat-item">
                        <span class="stat-num" id="stat-seguidores">0</span>
                        <span class="stat-label">Seguidores</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-num" id="stat-siguiendo">0</span>
                        <span class="stat-label">Siguiendo</span>
                    </div>
                </div>

                <div id="p-lema" class="lema">"..."</div>
                <p id="p-bio" class="bio">...</p>

                <div style="background:#f4f6f8; padding:15px; border-radius:15px; text-align:left; margin-top:20px;">
                    <p style="margin:0; font-size:0.85em;">üó£Ô∏è <b>Habla:</b> <span id="p-idiomas-habla">...</span></p>
                    <p style="margin:5px 0 0; font-size:0.85em;">üìö <b>Aprende:</b> <span id="p-idiomas-aprende">...</span></p>
                </div>

                <div id="p-tags" class="tags-container"></div>

                <div id="contenedor-privado" style="display: none;">
                    <h3 style="text-align:left; border-bottom:2px solid #eee; padding-bottom:5px; margin-top:40px;">üì∏ BIT√ÅCORA DE VIAJES Y RUTAS</h3>
                    <div id="p-experiencias"></div>
                    
                    <div class="comments-section">
                        <h3>üí¨ Rese√±as de la Comunidad</h3>
                        <div id="form-comentario" style="display:none; background:#fdfdfd; padding:15px; border-radius:15px; border:1px dashed #ccc;">
                            <textarea id="txt-comentario" class="comment-input" rows="3" placeholder="Deja una rese√±a..."></textarea>
                            <button id="btn-send-comment" class="btn-comentar">Publicar Rese√±a</button>
                        </div>
                        <p id="aviso-login" style="display:none; font-size:0.8em; color:#888; text-align:center;">Debes iniciar sesi√≥n para comentar.</p>
                        <div id="lista-comentarios" class="lista-comentarios"></div>
                    </div>
                </div>

                <div id="bloqueo-candado" class="bloqueo-privacidad" style="display: none;">
                    <div class="candado-icon">üîí</div>
                    <h3 style="margin:0; text-align: center; border:none; color: var(--negro);">Perfil Privado</h3>
                    <p style="color:#666; font-size:0.9em;">Sigue a este usuario y espera que te acepte para ver su bit√°cora de viajes y rutas.</p>
                </div>

            </div>
        </div>
    </div>
    
    <script type="module">
        import { db, doc, getDoc, auth, onAuthStateChanged, collection, addDoc, query, where, orderBy, getDocs, onSnapshot, serverTimestamp } from './firebase-config.js';

        let perfilVisitadoID = ""; 
        let miUsuarioNombre = "An√≥nimo";
        let miUsuarioFoto = "";
        let miUid = null;
        let estadoConexion = "ninguna"; 

        onAuthStateChanged(auth, async (u) => {
            const params = new URLSearchParams(window.location.search);
            perfilVisitadoID = params.get('uid');
            
            if (u) {
                miUid = u.uid;
                if (!perfilVisitadoID) {
                    perfilVisitadoID = u.uid;
                    window.history.pushState({path:window.location.protocol + "//" + window.location.host + window.location.pathname + '?uid=' + perfilVisitadoID},'','?uid=' + perfilVisitadoID);
                }
                const miSnap = await getDoc(doc(db, "usuarios", miUid));
                if(miSnap.exists()) {
                    // üõ°Ô∏è DOMPURIFY APLICADO A TU PROPIO NOMBRE EN SESI√ìN
                    miUsuarioNombre = DOMPurify.sanitize(miSnap.data().nombre || u.displayName);
                    miUsuarioFoto = miSnap.data().foto || "";
                }

                // INYECCI√ìN: ESCUCHADOR DE LA CAMPANITA
                const qNotif = query(collection(db, "conexiones"), where("idSeguido", "==", miUid), where("estado", "==", "pendiente"));
                onSnapshot(qNotif, (snapshot) => {
                    const notifBadge = document.getElementById('notificacion-roja');
                    if (snapshot.size > 0) {
                        notifBadge.innerText = snapshot.size;
                        notifBadge.style.display = 'block';
                    } else {
                        notifBadge.style.display = 'none';
                    }
                });

                if (miUid === perfilVisitadoID) {
                    document.getElementById('btn-edit').style.display = 'block';
                    document.getElementById('contenedor-privado').style.display = 'block';
                    estadoConexion = "aceptado";
                } else { 
                    document.getElementById('btn-seguir').style.display = 'block'; 
                    document.getElementById('form-comentario').style.display = 'block'; 
                    verificarConexionEnTiempoReal(); 
                }
            } else { 
                document.getElementById('aviso-login').style.display = 'block'; 
                document.getElementById('bloqueo-candado').style.display = 'block';
            }
            
            if(perfilVisitadoID) { 
                await loadEstadisticasRedSocial(perfilVisitadoID);
                loadPerfil(perfilVisitadoID); 
            }
        });

        function verificarConexionEnTiempoReal() {
            try {
                const q = query(collection(db, "conexiones"), 
                    where("idSeguidor", "==", miUid),
                    where("idSeguido", "==", perfilVisitadoID)
                );
                
                onSnapshot(q, (snapshot) => {
                    const btnSeguir = document.getElementById('btn-seguir');
                    
                    if (!snapshot.empty) {
                        const conexion = snapshot.docs[0].data();
                        estadoConexion = conexion.estado; 
                        
                        if(estadoConexion === "pendiente") {
                            btnSeguir.innerText = "‚è≥ Pendiente";
                            btnSeguir.className = "btn-action pendiente";
                        } else if (estadoConexion === "aceptado") {
                            btnSeguir.innerText = "‚úîÔ∏è Siguiendo";
                            btnSeguir.className = "btn-action siguiendo";
                        }
                    } else {
                        estadoConexion = "ninguna";
                        btnSeguir.innerText = "‚ûï Seguir";
                        btnSeguir.className = "btn-action";
                    }

                    if(estadoConexion === "aceptado") {
                        document.getElementById('contenedor-privado').style.display = 'block';
                        document.getElementById('bloqueo-candado').style.display = 'none';
                        loadComentarios(perfilVisitadoID); 
                    } else {
                        document.getElementById('contenedor-privado').style.display = 'none';
                        document.getElementById('bloqueo-candado').style.display = 'block';
                    }
                });

            } catch (error) { console.error("Error verificando conexi√≥n:", error); }
        }

        async function loadEstadisticasRedSocial(uid) {
            try {
                const qSeguidores = query(collection(db, "conexiones"), where("idSeguido", "==", uid), where("estado", "==", "aceptado"));
                onSnapshot(qSeguidores, (snap) => {
                    document.getElementById('stat-seguidores').innerText = snap.size;
                });

                const qSiguiendo = query(collection(db, "conexiones"), where("idSeguidor", "==", uid), where("estado", "==", "aceptado"));
                onSnapshot(qSiguiendo, (snap) => {
                    document.getElementById('stat-siguiendo').innerText = snap.size;
                });
            } catch (e) { console.log(e); }
        }

        document.getElementById('btn-seguir').onclick = async () => {
            const btn = document.getElementById('btn-seguir');
            if(estadoConexion !== "ninguna") return; 

            btn.innerText = "Enviando...";
            try {
                await addDoc(collection(db, "conexiones"), {
                    idSeguidor: miUid,
                    nombreSeguidor: miUsuarioNombre,
                    fotoSeguidor: miUsuarioFoto,
                    idSeguido: perfilVisitadoID,
                    estado: "pendiente", 
                    fechaSolicitud: serverTimestamp()
                });
            } catch (e) {
                console.error(e);
                btn.innerText = "‚ûï Seguir";
                alert("Error al enviar solicitud.");
            }
        };

        async function loadPerfil(uid) {
            try {
                const snap = await getDoc(doc(db, "usuarios", uid));
                if (snap.exists()) {
                    const d = snap.data();
                    document.getElementById('p-foto').src = d.foto || "https://ui-avatars.com/api/?name=Viajero&background=80C4C8&color=fff";
                    
                    // üõ°Ô∏è DOMPURIFY APLICADO A LA VISUALIZACI√ìN DE DATOS P√öBLICOS
                    document.getElementById('p-nombre').innerText = DOMPurify.sanitize(d.nombre);
                    document.getElementById('p-rol').innerText = DOMPurify.sanitize(d.rol || "VIAJERO");
                    document.getElementById('p-ubicacion').innerText = DOMPurify.sanitize(d.ubicacion || "Mundo");
                    document.getElementById('p-lema').innerText = `"${DOMPurify.sanitize(d.titularCorto || 'Explorando...')}"`;
                    document.getElementById('p-bio').innerText = DOMPurify.sanitize(d.bio || "Sin biograf√≠a.");
                    
                    const habla = d.idiomasHabla ? DOMPurify.sanitize(d.idiomasHabla.join(', ')) : "No especificado";
                    const aprende = d.idiomasAprende ? DOMPurify.sanitize(d.idiomasAprende.join(', ')) : "Ninguno";
                    document.getElementById('p-idiomas-habla').innerText = habla;
                    document.getElementById('p-idiomas-aprende').innerText = aprende;

                    const tags = [...(d.interesesOutdoor || []), ...(d.interesesGeneral || [])];
                    tags.forEach(t => document.getElementById('p-tags').innerHTML += `<div class="tag">${DOMPurify.sanitize(t)}</div>`);

                    const expDiv = document.getElementById('p-experiencias');
                    if (d.experiencias && d.experiencias.length > 0) {
                        d.experiencias.forEach(e => {
                            let fotosHTML = "";
                            if(e.fotos) e.fotos.forEach(f => fotosHTML += `<img src="${f}" class="exp-foto" onclick="window.open('${f}')">`);
                            expDiv.innerHTML += `<div class="exp-card"><div class="exp-header"><h4 class="exp-titulo">${DOMPurify.sanitize(e.titulo)}</h4><span class="exp-lugar">üìç ${DOMPurify.sanitize(e.lugar)}</span></div><div class="exp-desc">${DOMPurify.sanitize(e.descripcion)}</div><div class="exp-galeria">${fotosHTML}</div></div>`;
                        });
                    } else if (d.pasaporteViajes && d.pasaporteViajes.length > 0) {
                        d.pasaporteViajes.forEach(r => {
                            expDiv.innerHTML += `<div class="exp-card"><div class="exp-header"><h4 class="exp-titulo">${DOMPurify.sanitize(r.lugar)}</h4></div><div class="exp-desc">${DOMPurify.sanitize(r.descripcion)}</div><div class="exp-galeria"><img src="${r.foto}" class="exp-foto" onclick="window.open('${r.foto}')"></div></div>`;
                        });
                    } else {
                        expDiv.innerHTML = "<p style='color:#ccc; text-align:center;'>Sin experiencias a√∫n.</p>";
                    }

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('perfil-content').style.display = 'block';
                }
            } catch (error) { console.error(error); document.getElementById('loading').innerText = "Error cargando perfil."; }
        }

        async function loadComentarios(uid) {
            const list = document.getElementById('lista-comentarios'); list.innerHTML = "";
            const q = query(collection(db, "usuarios", uid, "resenas"), orderBy("fecha", "desc"));
            const snap = await getDocs(q);
            if(snap.empty) { list.innerHTML = "<p style='color:#ccc; font-size:0.8em; text-align:center;'>S√© el primero en escribir.</p>"; return; }
            snap.forEach(d => {
                const c = d.data();
                let fechaStr = "Reciente"; if(c.fecha) fechaStr = new Date(c.fecha.seconds*1000).toLocaleDateString();
                
                // üõ°Ô∏è DOMPURIFY APLICADO AL LEER LOS COMENTARIOS
                list.innerHTML += `<div class="comentario-item"><div class="comentario-autor"><span>${DOMPurify.sanitize(c.autorNombre)}</span><span class="comentario-fecha">${fechaStr}</span></div><div class="comentario-texto">${DOMPurify.sanitize(c.contenido)}</div></div>`;
            });
        }

        document.getElementById('btn-send-comment').onclick = async () => {
            // üõ°Ô∏è DOMPURIFY APLICADO AL ENVIAR UN NUEVO COMENTARIO
            const txt = DOMPurify.sanitize(document.getElementById('txt-comentario').value);
            if(!txt.trim()) return;
            
            const btn = document.getElementById('btn-send-comment'); btn.innerText = "..."; btn.disabled = true;
            await addDoc(collection(db, "usuarios", perfilVisitadoID, "resenas"), { autorNombre: miUsuarioNombre, contenido: txt, fecha: serverTimestamp() });
            document.getElementById('txt-comentario').value = ""; loadComentarios(perfilVisitadoID); btn.innerText = "Publicar Rese√±a"; btn.disabled = false;
        };
    </script>
</body>
</html>