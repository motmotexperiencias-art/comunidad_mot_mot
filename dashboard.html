<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Bit√°cora - Mot Mot</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --naranja: #E65127; --turquesa: #80C4C8; --negro: #1a1a1a; --gris-fondo: #f4f6f8; --dorado: #D4AF37;}
        body { font-family: 'Montserrat', sans-serif; background-color: var(--gris-fondo); margin: 0; color: var(--negro); }
        .dashboard-nav { background: white; padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-logo { height: 35px; cursor: pointer; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .avatar-inicial { width: 40px; height: 40px; border-radius: 50%; background: var(--turquesa); color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; overflow: hidden; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-content { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .btn-crear { background-color: var(--naranja); color: white; padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: 800; font-size: 0.85em; text-transform: uppercase; display: inline-block; }
        .search-section { background: white; padding: 25px; border-radius: 20px; margin-top: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        /* üõ°Ô∏è CORRECCI√ìN DEL BUSCADOR PARA RESPONSIVE */
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input { flex: 1; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-family: 'Montserrat'; font-size: 1em; outline: none; transition:0.3s; min-width: 200px; box-sizing: border-box;}
        .search-input:focus { border-color: var(--turquesa); }
        .btn-buscar { background: var(--negro); color: white; border: none; padding: 15px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; transition:0.3s; font-family: 'Montserrat'; white-space: nowrap;}
        .btn-buscar:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        
        .filtros { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .chip { padding: 8px 20px; border-radius: 20px; background: #eee; cursor: pointer; font-size: 0.85em; font-weight: 700; transition: 0.3s; white-space: nowrap; }
        .chip.activo { background: var(--turquesa); color: white; box-shadow: 0 4px 10px rgba(128, 196, 200, 0.4); }
        .filtro-interes-select { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; font-family: 'Montserrat'; font-size: 0.9em; background-color: #fafafa; outline:none; box-sizing: border-box;}
        .usuario-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer; text-decoration: none; color: inherit; display: flex; flex-direction: column; align-items: center; border: 1px solid transparent; position: relative;}
        .usuario-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--turquesa); }
        .badge-mini { font-size: 0.6em; text-transform: uppercase; padding: 3px 8px; border-radius: 10px; background: #eee; margin-top: 5px; font-weight: bold; }
        .badge-mini.anfitrion { background: #FFF3E0; color: #E65127; }
        .badge-mini.guia { background: #E0F7FA; color: #006064; }
        .intereses-mini { font-size: 0.65em; color: #999; margin-top: 10px; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        #alerta-perfil { background: var(--naranja); color: white; padding: 12px; border-radius: 10px; margin-bottom: 25px; display: none; text-align: center; font-weight: 700; font-size: 0.85em; }
        
        .panel-guia { background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: white; padding: 20px 30px; border-radius: 20px; margin-top: 25px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-left: 5px solid var(--dorado); animation: fadeIn 0.5s ease; }
        .btn-vender { background: var(--dorado); color: var(--negro); padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: 900; font-size: 0.9em; text-transform: uppercase; transition: 0.3s; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);}
        .btn-vender:hover { transform: scale(1.05); background: white; color: var(--negro); box-shadow: 0 6px 15px rgba(255, 255, 255, 0.3);}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .icono-campana { font-size: 1.5em; cursor: pointer; position: relative; text-decoration: none; margin-right: 15px;}
        .punto-rojo { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.5em; font-weight: bold; display: none; border: 2px solid white;}

        @media (max-width: 768px) {
            .nav-perfil { padding: 10px 15px; flex-direction: column; gap: 10px; text-align: center; }
            /* üõ°Ô∏è REGLA PARA QUE EL BOT√ìN BUSCAR OCUPE EL 100% EN M√ìVIL Y NO SE SALGA */
            .btn-buscar { width: 100%; }
        }
    </style>
</head>
<body>
    <nav class="dashboard-nav">
        <div style="width: 40px;"></div> 
        <div class="user-menu">
            <a href="perfil.html" class="icono-campana" title="Notificaciones">
                üîî<span id="notificacion-roja" class="punto-rojo">0</span>
            </a>
            <a href="#" id="link-mi-perfil" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:10px;">
                <span id="nav-nombre">Explorador</span>
                <div id="avatar-container" class="avatar-inicial">M</div>
            </a>
            <button id="btn-salir" data-i18n="btn_salir" style="background:none; border:1px solid #ddd; padding:5px 10px; border-radius:15px; cursor:pointer;">Salir</button>
        </div>
    </nav>

    <div class="main-content">
        <div id="alerta-perfil" data-i18n="alerta_ubi">üìç Tu ubicaci√≥n no est√° definida. <a href="perfil.html" data-i18n="configurar_ya" style="color:white; text-decoration:underline;">CONFIGURAR AHORA</a></div>
        
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h1 data-i18n="titulo_bitacora" style="font-size:2.2em; font-weight:900; margin:0; text-transform:uppercase;">Mi Bit√°cora</h1>
                <p data-i18n="subtitulo" style="color:#666; margin-top:5px;">Conecta con aventureros reales.</p>
            </div>
            <a href="perfil.html" data-i18n="btn_editar" class="btn-crear">Editar mi Perfil</a>
        </div>

        <div id="panel-guia" class="panel-guia" style="display:none;">
            <div>
                <h3 data-i18n="p_guia_tit" style="margin: 0; font-size: 1.2em; color: var(--dorado); text-transform: uppercase;">Eres un Gu√≠a Profesional üèïÔ∏è</h3>
                <p data-i18n="p_guia_sub" style="margin: 5px 0 0 0; font-size: 0.85em; color: #ccc;">Publica tus rutas y caminatas para que los viajeros te encuentren.</p>
            </div>
            <a href="guias.html" data-i18n="p_guia_btn" class="btn-vender">üëë Crear Ruta</a>
        </div>

        <div id="panel-anfitrion" class="panel-guia" style="display:none;">
            <div>
                <h3 data-i18n="p_anf_tit" style="margin: 0; font-size: 1.2em; color: var(--dorado); text-transform: uppercase;">Eres Anfitri√≥n Local üßë‚Äçüåæ</h3>
                <p data-i18n="p_anf_sub" style="margin: 5px 0 0 0; font-size: 0.85em; color: #ccc;">¬øTe gustar√≠a ense√±ar un oficio, dar un taller o vender tu itinerario?</p>
            </div>
            <a href="guias.html" data-i18n="p_anf_btn" class="btn-vender">üëë Publicar Experiencia</a>
        </div>

        <div id="panel-viajero" class="panel-guia" style="display:none;">
            <div>
                <h3 data-i18n="p_via_tit" style="margin: 0; font-size: 1.2em; color: var(--naranja); text-transform: uppercase;">Eres un Viajero üéí</h3>
                <p data-i18n="p_via_sub" style="margin: 5px 0 0 0; font-size: 0.85em; color: #ccc;">¬øQuieres planear tu viaje, crear tu ruta y compartirla con la comunidad?</p>
            </div>
            <a href="guias.html" data-i18n="p_via_btn" class="btn-vender" style="background:var(--naranja); color:white;">üìç Armar Mi Viaje</a>
        </div>

        <div class="search-section">
            <div class="search-bar">
                <input type="text" id="input-buscar" data-i18n="buscar_place" class="search-input" placeholder="¬øA d√≥nde quieres ir? (Ej: Barichara)">
                <button id="btn-buscar" data-i18n="btn_buscar" class="btn-buscar">üîç Buscar</button>
            </div>
            <label data-i18n="rol_label" style="font-size:0.7em; font-weight:bold; color:#aaa; text-transform:uppercase;">Filtrar por Rol:</label>
            <div class="filtros">
                <div class="chip activo" data-i18n="f_todos" onclick="setFiltroRol('todos', this)">üåç Todos</div>
                <div class="chip" data-i18n="f_anfitrion" onclick="setFiltroRol('anfitrion', this)">üè† Anfitriones</div>
                <div class="chip" data-i18n="f_guia" onclick="setFiltroRol('guia', this)">üö© Gu√≠as</div>
                <div class="chip" data-i18n="f_viajero" onclick="setFiltroRol('viajero', this)">üéí Viajeros</div>
            </div>
            <label data-i18n="interes_label" style="font-size:0.7em; font-weight:bold; color:#aaa; text-transform:uppercase;">Por Inter√©s:</label>
            <select id="filtro-interes" onchange="renderResults()" class="filtro-interes-select">
                <option value="todos" data-i18n="opt_todos">Todos los intereses</option>
                <option value="ü•æ Hiking">ü•æ Hiking</option>
                <option value="üêï Caminar con perros">üêï Caminar con perros</option>
                <option value="‚ú® Golden Hour Walk">‚ú® Golden Hour Walk</option>
                <option value="ü•¶ Caminata 420">ü•¶ Caminata 420</option>
                <option value="üßò‚Äç‚ôÇÔ∏è Yoga">üßò‚Äç‚ôÇÔ∏è Yoga</option>
                <option value="üì∏ Caminata Fotogr√°fica">üì∏ Fotograf√≠a</option>
                <option value="üó£Ô∏è Aprender Idiomas">üó£Ô∏è Idiomas</option>
                <option value="üõ∏ Ovnis/Misterios">üõ∏ Ovnis</option>
                <option value="üç∫ Caminata y Cerveza">üç∫ Cerveza</option>
            </select>
        </div>

        <div style="margin-top:30px;">
            <h3 data-i18n="exploradores" style="font-size:1em; text-transform:uppercase; letter-spacing:1px; color:#888;">Exploradores encontrados</h3>
            <div id="contenedor-comunidad" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:20px; margin-top:20px;">
                <p data-i18n="vacio" style="color:#999; grid-column:1/-1; text-align:center;">Usa el buscador para ver qui√©n est√° en el destino.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, doc, getDoc, collection, query, getDocs, where, onSnapshot, onAuthStateChanged, signOut } from './firebase-config.js';

        let cacheUsers = []; let currentRol = 'todos';
        let misSiguiendo = []; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                if(snap.exists()){
                    const d = snap.data();
                    
                    const langC = localStorage.getItem('motmot_lang') || 'es';
                    const navFallback = window.diccionarioGlobal ? window.diccionarioGlobal[langC].explorador_nav : "Explorador";
                    document.getElementById('nav-nombre').innerText = (d.nombre || navFallback).split(' ')[0];
                    
                    if(d.foto) document.getElementById('avatar-container').innerHTML = `<img src="${d.foto}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                    else document.getElementById('avatar-container').innerText = d.nombre ? d.nombre.charAt(0).toUpperCase() : "M";
                    
                    document.getElementById('link-mi-perfil').href = `perfil-publico.html?uid=${user.uid}`;
                    
                    if(!d.ubicacion) document.getElementById('alerta-perfil').style.display = 'block';
                    else {
                        const ciudadLimpia = d.ubicacion.split(',')[0];
                        document.getElementById('input-buscar').value = ciudadLimpia;
                        search(ciudadLimpia);
                    }

                    if (d.rol === 'guia') {
                        document.getElementById('panel-guia').style.display = 'flex';
                    } else if (d.rol === 'anfitrion') {
                        document.getElementById('panel-anfitrion').style.display = 'flex';
                    } else {
                        document.getElementById('panel-viajero').style.display = 'flex'; 
                    }

                    try {
                        const qSiguiendo = query(collection(db, "conexiones"), where("idSeguidor", "==", user.uid), where("estado", "==", "aceptado"));
                        const snapSiguiendo = await getDocs(qSiguiendo);
                        snapSiguiendo.forEach(docX => { misSiguiendo.push(docX.data().idSeguido); });
                    } catch(e) { console.error("Error red social:", e) }

                    // üõ°Ô∏è MOTOR DE NOTIFICACIONES MULTIPLE (Amigos + Curadur√≠a)
                    // 1. Escuchar solicitudes de amistad pendientes
                    const qAmigos = query(collection(db, "conexiones"), where("idSeguido", "==", user.uid), where("estado", "==", "pendiente"));
                    // 2. Escuchar notificaciones de curadur√≠a NO le√≠das
                    const qCuraduria = query(collection(db, "notificaciones"), where("receptorId", "==", user.uid), where("leida", "==", false));

                    const actualizarCampana = async () => {
                        try {
                            const snapAmigos = await getDocs(qAmigos);
                            const snapCuraduria = await getDocs(qCuraduria);
                            const totalPendientes = snapAmigos.size + snapCuraduria.size;

                            const notifBadge = document.getElementById('notificacion-roja');
                            if (totalPendientes > 0) {
                                notifBadge.innerText = totalPendientes;
                                notifBadge.style.display = 'block';
                            } else {
                                notifBadge.style.display = 'none';
                            }
                        } catch(error) {
                            console.error("Error cargando campana", error);
                        }
                    };

                    // Poner a escuchar cambios en tiempo real en ambas colecciones
                    onSnapshot(qAmigos, () => actualizarCampana());
                    onSnapshot(qCuraduria, () => actualizarCampana());
                }
            } else window.location.replace('index.html');
        });

        async function search(termino) {
            const container = document.getElementById('contenedor-comunidad');
            const lang = localStorage.getItem('motmot_lang') || 'es';
            const vacioText = window.diccionarioGlobal ? window.diccionarioGlobal[lang].vacio : "Buscando...";
            container.innerHTML = `<p style='color:#ccc; grid-column:1/-1; text-align:center;'>${vacioText}</p>`;
            
            try {
                const q = query(collection(db, "usuarios"));
                const snap = await getDocs(q);
                cacheUsers = []; const terminoLower = termino.toLowerCase().trim();
                snap.forEach(doc => {
                    const d = doc.data(); d.uid = doc.id;
                    if(d.uid !== auth.currentUser.uid && d.ubicacion?.toLowerCase().includes(terminoLower)) cacheUsers.push(d);
                });
                renderResults();
            } catch (error) { console.error(error); container.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>Error buscando.</p>"; }
        }

        window.renderResults = () => {
            const container = document.getElementById('contenedor-comunidad'); container.innerHTML = "";
            const interes = document.getElementById('filtro-interes').value;
            
            const lang = localStorage.getItem('motmot_lang') || 'es';
            const dict = window.diccionarioGlobal ? window.diccionarioGlobal[lang] : null;

            const filtered = cacheUsers.filter(u => {
                const matchRol = currentRol === 'todos' || u.rol === currentRol;
                let matchInt = true;
                if(interes !== 'todos') {
                    const allTags = [...(u.interesesOutdoor || []), ...(u.interesesGeneral || []), ...(u.idiomasHabla || []), ...(u.idiomasAprende || [])];
                    matchInt = allTags.includes(interes);
                }
                return matchRol && matchInt;
            });

            if(filtered.length === 0) { 
                const emptyMsg = dict ? dict.vacio : "No hay resultados.";
                container.innerHTML = `<p style='grid-column:1/-1; text-align:center; color:#999;'>${emptyMsg}</p>`; 
                return; 
            }

            filtered.forEach(p => {
                const foto = p.foto && !p.foto.includes("ui-avatars") ? p.foto : `https://ui-avatars.com/api/?name=${p.nombre}&background=80C4C8&color=fff`;
                
                let rawRol = p.rol || 'viajero';
                let rolLimpio = rawRol;
                if (dict) {
                    if (rawRol === 'guia') rolLimpio = dict.rol_guia;
                    if (rawRol === 'anfitrion') rolLimpio = dict.rol_anfitrion;
                    if (rawRol === 'viajero') rolLimpio = dict.rol_viajero;
                }

                const fallbackUser = dict ? dict.default_user : "Usuario";
                const fallbackEtiquetas = dict ? dict.sin_etiquetas : "Sin etiquetas";

                const interesesMuestra = [...(p.interesesOutdoor || []), ...(p.interesesGeneral || [])].slice(0, 2).join(' ‚Ä¢ ');
                
                const esAmigo = misSiguiendo.includes(p.uid);
                const badgeAmigo = esAmigo ? `<div style="position:absolute; top:-10px; right:-10px; background:#4CAF50; color:white; padding:5px 10px; border-radius:15px; font-size:0.7em; font-weight:900; box-shadow:0 4px 10px rgba(76, 175, 80, 0.4); z-index:10;">‚úîÔ∏è AMIGO</div>` : "";

                container.innerHTML += `
                    <a href="perfil-publico.html?uid=${p.uid}" class="usuario-card">
                        ${badgeAmigo}
                        <img src="${foto}" style="width:70px; height:70px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:2px solid #eee;">
                        <b style="font-size:1em;">${(p.nombre || fallbackUser).split(' ')[0]}</b>
                        <div class="badge-mini ${rawRol}">${rolLimpio}</div>
                        <div class="intereses-mini">${interesesMuestra || fallbackEtiquetas}</div>
                    </a>`;
            });
        }

        window.setFiltroRol = (rol, el) => {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('activo'));
            el.classList.add('activo'); currentRol = rol; renderResults();
        };

        document.getElementById('btn-buscar').onclick = () => search(document.getElementById('input-buscar').value);
        document.getElementById('btn-salir').onclick = () => signOut(auth).then(() => window.location.replace('index.html'));
    </script>
    <script type="module" src="firebase-config.js"></script>
</body>
</html>