<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Bit√°cora - Mot Mot</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --naranja: #E65127; --turquesa: #80C4C8; --negro: #1a1a1a; --gris-fondo: #f4f6f8; --dorado: #D4AF37;}
        body { font-family: 'Montserrat', sans-serif; background-color: var(--gris-fondo); margin: 0; color: var(--negro); }
        .dashboard-nav { background: white; padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-logo { height: 35px; cursor: pointer; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .avatar-inicial { width: 40px; height: 40px; border-radius: 50%; background: var(--turquesa); color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; overflow: hidden; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-content { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .btn-crear { background-color: var(--naranja); color: white; padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: 800; font-size: 0.85em; text-transform: uppercase; display: inline-block; }
        .search-section { background: white; padding: 25px; border-radius: 20px; margin-top: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-family: 'Montserrat'; font-size: 1em; outline: none; transition:0.3s;}
        .search-input:focus { border-color: var(--turquesa); }
        .btn-buscar { background: var(--negro); color: white; border: none; padding: 0 25px; border-radius: 12px; font-weight: bold; cursor: pointer; transition:0.3s;}
        .btn-buscar:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .filtros { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .chip { padding: 8px 20px; border-radius: 20px; background: #eee; cursor: pointer; font-size: 0.85em; font-weight: 700; transition: 0.3s; white-space: nowrap; }
        .chip.activo { background: var(--turquesa); color: white; box-shadow: 0 4px 10px rgba(128, 196, 200, 0.4); }
        .filtro-interes-select { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; font-family: 'Montserrat'; font-size: 0.9em; background-color: #fafafa; outline:none;}
        .usuario-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer; text-decoration: none; color: inherit; display: flex; flex-direction: column; align-items: center; border: 1px solid transparent; position: relative;}
        .usuario-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--turquesa); }
        .badge-mini { font-size: 0.6em; text-transform: uppercase; padding: 3px 8px; border-radius: 10px; background: #eee; margin-top: 5px; font-weight: bold; }
        .badge-mini.anfitrion { background: #FFF3E0; color: #E65127; }
        .badge-mini.guia { background: #E0F7FA; color: #006064; }
        .intereses-mini { font-size: 0.65em; color: #999; margin-top: 10px; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        #alerta-perfil { background: var(--naranja); color: white; padding: 12px; border-radius: 10px; margin-bottom: 25px; display: none; text-align: center; font-weight: 700; font-size: 0.85em; }
        
        .panel-guia { background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: white; padding: 20px 30px; border-radius: 20px; margin-top: 25px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-left: 5px solid var(--dorado); animation: fadeIn 0.5s ease; }
        .btn-vender { background: var(--dorado); color: var(--negro); padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: 900; font-size: 0.9em; text-transform: uppercase; transition: 0.3s; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);}
        .btn-vender:hover { transform: scale(1.05); background: white; color: var(--negro); box-shadow: 0 6px 15px rgba(255, 255, 255, 0.3);}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* INYECCI√ìN DE ESTILOS: Campanita */
        .icono-campana { font-size: 1.5em; cursor: pointer; position: relative; text-decoration: none; margin-right: 15px;}
        .punto-rojo { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.5em; font-weight: bold; display: none; border: 2px solid white;}

        /* =========================================
           üì± PARCHE M√ìVIL (RESPONSIVE DESIGN MEJORADO)
           ========================================= */
        @media (max-width: 768px) {
            /* 1. M√°rgenes m√°s peque√±os para aprovechar la pantalla */
            .container { margin: 10px auto; padding: 10px; }
            .card-form { padding: 20px 15px; border-radius: 15px; }
            
            /* 2. Textos m√°s grandes y legibles */
            h1 { font-size: 1.4em !important; text-align: center; }
            h3 { font-size: 1em; text-align: center; }
            label { font-size: 0.95em; }
            input, select, textarea { font-size: 16px !important; } /* 16px evita que el iPhone haga zoom autom√°tico al escribir */

            /* 3. Navegaci√≥n superior ajustada */
            .nav-perfil { padding: 10px 15px; flex-direction: column; gap: 10px; text-align: center; }
            .nav-logo { height: 30px; }

            /* 4. Romper las grillas a una sola columna (Paso 3 y otros) */
            div[style*="grid-template-columns"] { 
                grid-template-columns: 1fr !important; 
                gap: 15px !important; 
            }

            /* 5. Botones gigantes y f√°ciles de tocar */
            .btn-nav, .btn-enviar, .btn-add { 
                width: 100%; 
                padding: 15px; 
                font-size: 1em; 
                float: none; 
                display: block; 
                margin-top: 10px; 
            }
            
            /* 6. El Stepper (Los 6 pasos de arriba) ajustado para que no se amontone */
            .stepper { flex-wrap: wrap; gap: 5px; font-size: 0.6em; }
            .step-indicator { padding: 5px; border-bottom-width: 2px; }
        }
    </style>
</head>
<body>
    <nav class="dashboard-nav">
        <img src="https://www.motmotexperiencias.com/wp-content/uploads/2023/08/cropped-Logo-foto-de-perfil-instagram.png" class="nav-logo" onclick="window.location.reload()">
        <div class="user-menu">
            
            <a href="perfil.html" class="icono-campana" title="Notificaciones">
                üîî<span id="notificacion-roja" class="punto-rojo">0</span>
            </a>

            <a href="#" id="link-mi-perfil" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:10px;">
                <span id="nav-nombre">Explorador</span>
                <div id="avatar-container" class="avatar-inicial">M</div>
            </a>
            <button id="btn-salir" style="background:none; border:1px solid #ddd; padding:5px 10px; border-radius:15px; cursor:pointer;">Salir</button>
        </div>
    </nav>

    <div class="main-content">
        <div id="alerta-perfil">üìç Tu ubicaci√≥n no est√° definida. <a href="perfil.html" style="color:white; text-decoration:underline;">CONFIGURAR AHORA</a></div>
        
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h1 style="font-size:2.2em; font-weight:900; margin:0; text-transform:uppercase;">Mi Bit√°cora</h1>
                <p style="color:#666; margin-top:5px;">Conecta con aventureros reales.</p>
            </div>
            <a href="perfil.html" class="btn-crear">Editar mi Perfil</a>
        </div>

        <div id="panel-vendedor" class="panel-guia">
            </div>

        <div class="search-section">
            <div class="search-bar">
                <input type="text" id="input-buscar" class="search-input" placeholder="¬øA d√≥nde quieres ir? (Ej: Barichara)">
                <button id="btn-buscar" class="btn-buscar">üîç Buscar</button>
            </div>
            <label style="font-size:0.7em; font-weight:bold; color:#aaa; text-transform:uppercase;">Filtrar por Rol:</label>
            <div class="filtros">
                <div class="chip activo" onclick="setFiltroRol('todos', this)">üåç Todos</div>
                <div class="chip" onclick="setFiltroRol('anfitrion', this)">üè† Anfitriones</div>
                <div class="chip" onclick="setFiltroRol('guia', this)">üö© Gu√≠as</div>
                <div class="chip" onclick="setFiltroRol('viajero', this)">üéí Viajeros</div>
            </div>
            <label style="font-size:0.7em; font-weight:bold; color:#aaa; text-transform:uppercase;">Por Inter√©s:</label>
            <select id="filtro-interes" onchange="renderResults()" class="filtro-interes-select">
                <option value="todos">Todos los intereses</option>
                <option value="ü•æ Hiking">ü•æ Hiking</option>
                <option value="üêï Caminar con perros">üêï Caminar con perros</option>
                <option value="‚ú® Golden Hour Walk">‚ú® Golden Hour Walk</option>
                <option value="ü•¶ Caminata 420">ü•¶ Caminata 420</option>
                <option value="üßò‚Äç‚ôÇÔ∏è Yoga">üßò‚Äç‚ôÇÔ∏è Yoga</option>
                <option value="üì∏ Caminata Fotogr√°fica">üì∏ Fotograf√≠a</option>
                <option value="üó£Ô∏è Aprender Idiomas">üó£Ô∏è Idiomas</option>
                <option value="üõ∏ Ovnis/Misterios">üõ∏ Ovnis</option>
                <option value="üç∫ Caminata y Cerveza">üç∫ Cerveza</option>
            </select>
        </div>

        <div style="margin-top:30px;">
            <h3 style="font-size:1em; text-transform:uppercase; letter-spacing:1px; color:#888;">Exploradores encontrados</h3>
            <div id="contenedor-comunidad" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:20px; margin-top:20px;">
                <p style="color:#999; grid-column:1/-1; text-align:center;">Usa el buscador para ver qui√©n est√° en el destino.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // INYECCI√ìN: Agregamos where y onSnapshot a tu importaci√≥n
        import { auth, db, doc, getDoc, collection, query, getDocs, where, onSnapshot, onAuthStateChanged, signOut } from './firebase-config.js';

        let cacheUsers = []; let currentRol = 'todos';
        let misSiguiendo = []; // INYECCI√ìN: Para el sello de amigo

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                if(snap.exists()){
                    const d = snap.data();
                    
                    document.getElementById('nav-nombre').innerText = (d.nombre || "Explorador").split(' ')[0];
                    if(d.foto) document.getElementById('avatar-container').innerHTML = `<img src="${d.foto}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                    else document.getElementById('avatar-container').innerText = d.nombre ? d.nombre.charAt(0).toUpperCase() : "M";
                    
                    document.getElementById('link-mi-perfil').href = `perfil-publico.html?uid=${user.uid}`;
                    
                    if(!d.ubicacion) document.getElementById('alerta-perfil').style.display = 'block';
                    else {
                        const ciudadLimpia = d.ubicacion.split(',')[0];
                        document.getElementById('input-buscar').value = ciudadLimpia;
                        search(ciudadLimpia);
                    }

                    if (d.rol === 'guia') {
                        document.getElementById('panel-vendedor').innerHTML = `
                            <div>
                                <h3 style="margin: 0; font-size: 1.2em; color: var(--dorado); text-transform: uppercase;">Eres un Gu√≠a Profesional üèïÔ∏è</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #ccc;">Publica tus rutas y caminatas para que los viajeros te encuentren.</p>
                            </div>
                            <a href="guias.html" class="btn-vender">üëë Crear Ruta</a>
                        `;
                        document.getElementById('panel-vendedor').style.display = 'flex';
                    } else if (d.rol === 'anfitrion') {
                        document.getElementById('panel-vendedor').innerHTML = `
                            <div>
                                <h3 style="margin: 0; font-size: 1.2em; color: var(--dorado); text-transform: uppercase;">Eres Anfitri√≥n Local üßë‚Äçüåæ</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #ccc;">¬øTe gustar√≠a ense√±ar un oficio, dar un taller o vender tu itinerario?</p>
                            </div>
                            <a href="guias.html" class="btn-vender">üëë Publicar Experiencia</a>
                        `;
                        document.getElementById('panel-vendedor').style.display = 'flex';
                    } else {
                        document.getElementById('panel-vendedor').innerHTML = `
                            <div>
                                <h3 style="margin: 0; font-size: 1.2em; color: var(--naranja); text-transform: uppercase;">Eres un Viajero üéí</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #ccc;">¬øQuieres planear tu viaje, crear tu ruta y compartirla con la comunidad?</p>
                            </div>
                            <a href="guias.html" class="btn-vender" style="background:var(--naranja); color:white;">üìç Armar Mi Viaje</a>
                        `;
                        document.getElementById('panel-vendedor').style.display = 'flex'; 
                    }

                    // INYECCI√ìN: CARGAR LISTA DE AMIGOS
                    try {
                        const qSiguiendo = query(collection(db, "conexiones"), where("idSeguidor", "==", user.uid), where("estado", "==", "aceptado"));
                        const snapSiguiendo = await getDocs(qSiguiendo);
                        snapSiguiendo.forEach(docX => { misSiguiendo.push(docX.data().idSeguido); });
                    } catch(e) { console.error("Error red social:", e) }

                    // INYECCI√ìN: CAMPANITA EN TIEMPO REAL
                    const qNotif = query(collection(db, "conexiones"), where("idSeguido", "==", user.uid), where("estado", "==", "pendiente"));
                    onSnapshot(qNotif, (snapshot) => {
                        const notifBadge = document.getElementById('notificacion-roja');
                        if (snapshot.size > 0) {
                            notifBadge.innerText = snapshot.size;
                            notifBadge.style.display = 'block';
                        } else {
                            notifBadge.style.display = 'none';
                        }
                    });
                }
            } else window.location.replace('index.html');
        });

        async function search(termino) {
            const container = document.getElementById('contenedor-comunidad');
            container.innerHTML = "<p style='color:#ccc; grid-column:1/-1; text-align:center;'>Buscando...</p>";
            try {
                const q = query(collection(db, "usuarios"));
                const snap = await getDocs(q);
                cacheUsers = []; const terminoLower = termino.toLowerCase().trim();
                snap.forEach(doc => {
                    const d = doc.data(); d.uid = doc.id;
                    if(d.uid !== auth.currentUser.uid && d.ubicacion?.toLowerCase().includes(terminoLower)) cacheUsers.push(d);
                });
                renderResults();
            } catch (error) { console.error(error); container.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>Error buscando.</p>"; }
        }

        window.renderResults = () => {
            const container = document.getElementById('contenedor-comunidad'); container.innerHTML = "";
            const interes = document.getElementById('filtro-interes').value;
            const filtered = cacheUsers.filter(u => {
                const matchRol = currentRol === 'todos' || u.rol === currentRol;
                let matchInt = true;
                if(interes !== 'todos') {
                    const allTags = [...(u.interesesOutdoor || []), ...(u.interesesGeneral || []), ...(u.idiomasHabla || []), ...(u.idiomasAprende || [])];
                    matchInt = allTags.includes(interes);
                }
                return matchRol && matchInt;
            });

            if(filtered.length === 0) { container.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#999;'>No hay resultados para este filtro.</p>"; return; }

            filtered.forEach(p => {
                const foto = p.foto && !p.foto.includes("ui-avatars") ? p.foto : `https://ui-avatars.com/api/?name=${p.nombre}&background=80C4C8&color=fff`;
                const rolLimpio = p.rol || 'viajero';
                const interesesMuestra = [...(p.interesesOutdoor || []), ...(p.interesesGeneral || [])].slice(0, 2).join(' ‚Ä¢ ');
                
                // INYECCI√ìN: SELLO DE AMIGO VISUAL
                const esAmigo = misSiguiendo.includes(p.uid);
                const badgeAmigo = esAmigo ? `<div style="position:absolute; top:-10px; right:-10px; background:#4CAF50; color:white; padding:5px 10px; border-radius:15px; font-size:0.7em; font-weight:900; box-shadow:0 4px 10px rgba(76, 175, 80, 0.4); z-index:10;">‚úîÔ∏è AMIGO</div>` : "";

                container.innerHTML += `
                    <a href="perfil-publico.html?uid=${p.uid}" class="usuario-card">
                        ${badgeAmigo}
                        <img src="${foto}" style="width:70px; height:70px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:2px solid #eee;">
                        <b style="font-size:1em;">${(p.nombre || "Usuario").split(' ')[0]}</b>
                        <div class="badge-mini ${rolLimpio}">${rolLimpio}</div>
                        <div class="intereses-mini">${interesesMuestra || 'Sin etiquetas'}</div>
                    </a>`;
            });
        }

        window.setFiltroRol = (rol, el) => {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('activo'));
            el.classList.add('activo'); currentRol = rol; renderResults();
        };

        document.getElementById('btn-buscar').onclick = () => search(document.getElementById('input-buscar').value);
        document.getElementById('btn-salir').onclick = () => signOut(auth).then(() => window.location.replace('index.html'));
    </script>
</body>
</html>