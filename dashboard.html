<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificaciones - Mot Mot</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --naranja: #E65127; --turquesa: #80C4C8; --negro: #1a1a1a; --gris-fondo: #f4f6f8; --dorado: #D4AF37;}
        body { font-family: 'Montserrat', sans-serif; background-color: var(--gris-fondo); margin: 0; color: var(--negro); }
        .dashboard-nav { background: white; padding: 12px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-logo { height: 35px; cursor: pointer; }
        .main-content { max-width: 800px; margin: 40px auto; padding: 0 20px; }
        
        h1 { font-weight: 900; color: var(--negro); text-transform: uppercase; font-size: 2em; margin-bottom: 5px;}
        .seccion-notif { background: white; padding: 25px; border-radius: 20px; margin-top: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .seccion-titulo { font-size: 1.1em; color: var(--turquesa); text-transform: uppercase; font-weight: 800; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }

        /* Tarjetas de Notificaci√≥n */
        .notif-card { background: #fafafa; border: 1px solid #eee; padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .notif-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .notif-texto { font-size: 0.9em; line-height: 1.5; color: #444; }
        .notif-fecha { font-size: 0.75em; color: #999; margin-top: 5px; display: block; }
        
        /* Tipos de Alerta (Colores) */
        .alerta-sistema { border-left: 5px solid var(--naranja); background: #fffcf5; }
        .alerta-rechazo { border-left: 5px solid #d32f2f; background: #ffebee; }
        .alerta-aprobado { border-left: 5px solid var(--verde); background: #e8f5e9; }
        .alerta-social { border-left: 5px solid var(--turquesa); }

        .btn-accion { padding: 8px 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.8em; text-transform: uppercase;}
        .btn-aceptar { background: var(--turquesa); color: white; margin-right: 5px; }
        .btn-rechazar { background: #eee; color: #555; }
        .btn-leido { background: var(--negro); color: white; }

        .vacio { text-align: center; color: #999; font-style: italic; padding: 20px; }

        @media (max-width: 768px) {
            .dashboard-nav { padding: 15px; }
            .notif-card { flex-direction: column; align-items: flex-start; gap: 15px; }
            .notif-acciones { width: 100%; display: flex; gap: 10px; }
            .btn-accion { flex: 1; }
        }
    </style>
</head>
<body>
    <nav class="dashboard-nav">
        <img src="https://www.motmotexperiencias.com/wp-content/uploads/2023/08/cropped-Logo-foto-de-perfil-instagram.png" class="nav-logo" onclick="window.location.href='dashboard.html'">
        <a href="dashboard.html" style="text-decoration:none; color:var(--naranja); font-weight:800;">‚Üê VOLVER</a>
    </nav>

    <div class="main-content">
        <h1>Centro de Notificaciones</h1>
        <p style="color:#666; margin-top:0;">Mantente al d√≠a con tu comunidad y la plataforma.</p>

        <div class="seccion-notif">
            <h4 class="seccion-titulo">üè¢ Mensajes del Sistema</h4>
            <div id="contenedor-sistema">
                <div class="vacio">Cargando mensajes...</div>
            </div>
        </div>

        <div class="seccion-notif">
            <h4 class="seccion-titulo">üë• Solicitudes de Conexi√≥n</h4>
            <div id="contenedor-social">
                <div class="vacio">Cargando solicitudes...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, doc, getDoc, collection, query, where, onSnapshot, updateDoc, onAuthStateChanged, deleteDoc } from './firebase-config.js';

        let currentUserId = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                cargarAlertasSistema();
                cargarSolicitudesAmistad();
            } else {
                window.location.replace('index.html');
            }
        });

        // ----------------------------------------------------
        // 1. CARGAR ALERTAS DEL SISTEMA (Curadur√≠a)
        // ----------------------------------------------------
        function cargarAlertasSistema() {
            const q = query(collection(db, "notificaciones"), where("receptorId", "==", currentUserId), where("leida", "==", false));
            
            onSnapshot(q, (snapshot) => {
                const contenedor = document.getElementById('contenedor-sistema');
                contenedor.innerHTML = "";
                
                if (snapshot.empty) {
                    contenedor.innerHTML = `<div class="vacio">No tienes mensajes nuevos del sistema.</div>`;
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    
                    let claseColor = "alerta-sistema";
                    let icono = "üîî";
                    let mensajePrincipal = "Tienes una nueva notificaci√≥n.";

                    // Personalizar el mensaje seg√∫n lo que decidi√≥ Curadur√≠a
                    if (data.tipo === "estado_curaduria") {
                        if (data.nuevoEstado === "validado") {
                            claseColor = "alerta-sistema"; // Amarillo/Naranja
                            icono = "‚úÖ";
                            mensajePrincipal = `Tu experiencia <b>"${data.tituloServicio}"</b> ha sido revisada y validada. ¬°Pronto estar√° en Amelia!`;
                        } else if (data.nuevoEstado === "completado") {
                            claseColor = "alerta-aprobado"; // Verde
                            icono = "üöÄ";
                            mensajePrincipal = `¬°Felicidades! Tu experiencia <b>"${data.tituloServicio}"</b> ya est√° publicada y lista para recibir reservas.`;
                        } else if (data.nuevoEstado === "rechazado") {
                            claseColor = "alerta-rechazo"; // Rojo
                            icono = "‚ùå";
                            mensajePrincipal = `Tu experiencia <b>"${data.tituloServicio}"</b> no ha pasado el filtro de curadur√≠a. Por favor, revisa que la informaci√≥n y los documentos legales est√©n completos y vuelve a intentarlo.`;
                        }
                    }

                    // Formatear Fecha (Si existe)
                    let fechaTxt = "";
                    if (data.fechaHora) {
                        const dateObj = data.fechaHora.toDate();
                        fechaTxt = dateObj.toLocaleDateString() + " " + dateObj.toLocaleTimeString();
                    }

                    contenedor.innerHTML += `
                        <div class="notif-card ${claseColor}">
                            <div class="notif-texto">
                                <div><span style="font-size:1.2em; margin-right:10px;">${icono}</span> ${mensajePrincipal}</div>
                                <span class="notif-fecha">${fechaTxt}</span>
                            </div>
                            <div class="notif-acciones">
                                <button class="btn-accion btn-leido" onclick="marcarLeida('${id}')">Marcar Le√≠da</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // Marcar notificaci√≥n del sistema como le√≠da (para que desaparezca de esta lista y baje el contador de la campana)
        window.marcarLeida = async (idNotif) => {
            try {
                await updateDoc(doc(db, "notificaciones", idNotif), { leida: true });
            } catch (error) {
                console.error("Error al marcar como le√≠da:", error);
            }
        };

        // ----------------------------------------------------
        // 2. CARGAR SOLICITUDES DE AMISTAD (Social)
        // ----------------------------------------------------
        function cargarSolicitudesAmistad() {
            const q = query(collection(db, "conexiones"), where("idSeguido", "==", currentUserId), where("estado", "==", "pendiente"));
            
            onSnapshot(q, (snapshot) => {
                const contenedor = document.getElementById('contenedor-social');
                contenedor.innerHTML = "";
                
                if (snapshot.empty) {
                    contenedor.innerHTML = `<div class="vacio">No tienes solicitudes de conexi√≥n pendientes.</div>`;
                    return;
                }

                snapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    const idConexion = docSnap.id;
                    
                    // Buscar el nombre y foto de quien env√≠a la solicitud
                    let nombreSeguidor = "Un viajero";
                    let fotoSeguidor = "https://ui-avatars.com/api/?name=User&background=80C4C8&color=fff";
                    
                    try {
                        const perfilRef = await getDoc(doc(db, "usuarios", data.idSeguidor));
                        if(perfilRef.exists()) {
                            nombreSeguidor = perfilRef.data().nombre || "Un viajero";
                            if(perfilRef.data().foto) fotoSeguidor = perfilRef.data().foto;
                        }
                    } catch (e) { console.log(e); }

                    contenedor.innerHTML += `
                        <div class="notif-card alerta-social">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <img src="${fotoSeguidor}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                                <div class="notif-texto">
                                    <b>${nombreSeguidor}</b> quiere conectar contigo para ver tus rutas.
                                </div>
                            </div>
                            <div class="notif-acciones">
                                <button class="btn-accion btn-aceptar" onclick="responderSolicitud('${idConexion}', 'aceptado')">Aceptar</button>
                                <button class="btn-accion btn-rechazar" onclick="eliminarSolicitud('${idConexion}')">Rechazar</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // Acciones para la red social
        window.responderSolicitud = async (idConexion, nuevoEstado) => {
            try {
                await updateDoc(doc(db, "conexiones", idConexion), { estado: nuevoEstado });
            } catch (error) {
                console.error("Error al responder:", error);
            }
        };

        window.eliminarSolicitud = async (idConexion) => {
            if(confirm("¬øSeguro que deseas rechazar esta solicitud?")) {
                try {
                    await deleteDoc(doc(db, "conexiones", idConexion));
                } catch (error) {
                    console.error("Error al eliminar:", error);
                }
            }
        };

    </script>
</body>
</html>